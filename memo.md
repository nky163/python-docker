## ブランチ、環境、コンテナタグ戦略
### ブランチ
#### 前提
- シンプルにしたい
#### 戦略
- main
    - 安定ブランチ
    - 常にリリース可能なソースコードを管理
    - developからマージされる
- develop
    - 開発ブランチ
    - 開発中のソースコードを管理
    - featureからマージされる
    - リリース可能な状態でmainにマージ
- feature/{xxx} ({xxx}は開発機能名が入る想定)
    - 機能開発ブランチ
    - developブランチから、開発する機能に応じて作成
    - 機能開発完了時、developへのPR&マージ(3Wayマージ)

### 環境
#### 前提
- 本番環境は動作確認済みのアプリケーションを稼働させたい
- 最新のアプリケーションを動作確認できるようにしたい
- 開発者が任意のタイミングで開発中の資材を動作確認したい
#### 戦略
- prod
    - 本番環境
    - mainブランチのHEADの資材で構築
    - mainブランチへのマージをトリガーとしてパイプラインを実行してデプロイ
- dev
    - 開発環境
    - developブランチのHEADの資材で構築
    - developブランチへのマージをトリガーとしてパイプラインを実行してデプロイ
- dev-{xxx} ({xxx}は開発者名が入る想定)
    - 個人環境
    - 開発者が自由にデプロイ可能
    - ローカルからECRにDockerイメージPushをトリガーとしてパイプラインを実行してデプロイ

### コンテナイメージタグ付け
#### 前提
- コンテナイメージがどのソースコードでビルドされているか分かるようにしたい
- どのコンテナイメージがデプロイされているか分かるようにしたい
- 不要なコンテナイメージを判定して削除できるようにしたい
- 脆弱性があるコンテナイメージが分かるようにしたい
- (１つのコンテナイメージには複数のタグ付けが可能)
#### 戦略
- main.{コミットID}
    - 本番環境向けコンテナイメージ
- deploy-prod.{コミットID}
    - 本番環境デプロイ済みコンテナイメージ
- develop.{コミットID}
    - 開発環境向けコンテナイメージ
- deploy-dev.{コミットID}
    - 開発環境デプロイ済みコンテナイメージ
- feature.{コミットID}
    - 個人環境向けコンテナイメージ
- deploy-feature.{コミットID}
    - 個人環境デプロイ済みコンテナイメージ
- vulnerable-
    - 脆弱性があるコンテナイメージ

### ECRライフサイクルポリシー
#### 前提
- １リポジトリあたりに保管できるコンテナイメージ数の上限: 1000
- ECRのストレージの従量課金を節約したい
- 不要なコンテナイメージを残さないようにしたい
#### 戦略
- イメージタグで削除可否を判定する
- 上から順番に優先してポリシーが適用される
- deploy-*
    - 削除しない
- main.*
    - 削除しない
- dev.*
    - 最新3つを保持
- dev-{xxx}.*
    - 最新1つを保持
- その他
    - 7日で削除

### ECRイメージスキャン
#### 前提
- 脆弱性があるコンテナイメージをデプロイしたくない
- 脆弱性が発見されたコンテナイメージが分かるようにしたい
#### 戦略
- パイプラインでECRにコンテナイメージPush時にイメージスキャンを実行する
    - 脆弱性がある場合はデプロイを行わない
- Lambdaを定期実行して新規の脆弱性を検知する(1日1回)
    - 脆弱性が発見された場合、対象のコンテナイメージに「valnalable-cve-{cve番号}-{深刻度}」のタグ付けを行う
- 脆弱性を検知したらどこかしらかに通知

## CI/CDパイプライン
- CodeCommitのPR作成時とターゲットブランチ、ソースブランチが変更された時
    - ソースブランチをターゲットブランチへマージ
    - 単体テスト、結合テスト
    - コンテナイメージ作成
    - APIテスト?
- developブランチへのマージ時
    - 単体テスト、結合テスト
    - コンテナイメージ作成
    - APIテスト?
    - ECRへプッシュ
    - イメージスキャン
    - ECSへデプロイ
    - タグ付け更新
- mainブランチへのマージ時
    - 単体テスト、結合テスト
    - コンテナイメージ作成
    - APIテスト?
    - ECRへプッシュ
    - イメージスキャン
    - ECSへデプロイ
    - タグ付け更新
- 開発者によるECRへプッシュ時?
    - ECSへデプロイ
    - タグ付け更新


## TODO
- aws cdk
    - ALB、


## ドメインの管理
- 